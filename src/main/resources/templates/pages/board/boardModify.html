<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">

<div layout:fragment="content">
    <h2>게시글 수정</h2>

    <form name="frm" enctype="multipart/form-data">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <input type="hidden" name="id" th:value="${board.id}" />

        <!-- 제목 -->
        <div>
            제목:
            <input type="text" name="title" th:value="${board.title}" required />
        </div>

        <!-- 내용 -->
        <div>
            내용:
            <textarea name="content" rows="10" cols="50" required th:text="${board.content}"></textarea>
        </div>

        <!-- 기존 첨부파일 목록 -->
        <div th:if="${not #lists.isEmpty(board.attachments)}">
            <h3>첨부된 파일</h3>
            <div th:each="file : ${board.attachments}" class="existing-file">
                <span th:text="${file.orgFileName}"></span>
                <button type="button" class="delete-file" th:data-file-id="${file.id}">삭제</button>
            </div>
        </div>

        <!-- 새 파일 첨부 -->
        <div>
            <label for="fileUpload">새 첨부파일</label>
            <input type="file" id="fileUpload" name="mFiles" multiple>
            <div id="newFileList"></div>
        </div>

        <!-- 버튼 -->
        <div>
            <button type="submit">수정</button>
            <button type="button" onclick="location.href='/board'">목록</button>
        </div>
    </form>
</div>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form[name="frm"]');
            const fileUpload = document.getElementById('fileUpload');
            const newFileList = document.getElementById('newFileList');
            const boardId = /*[[${board.id}]]*/ '';  // Thymeleaf 인라인 JavaScript 문법
            const deletedFileIds = [];

            // 새 파일 선택 시 목록 표시
            fileUpload.addEventListener('change', function() {
                newFileList.innerHTML = '';
                Array.from(this.files).forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.textContent = `${file.name} (${formatFileSize(file.size)})`;
                    newFileList.appendChild(fileItem);
                });
            });

            // 기존 파일 삭제 버튼 이벤트
            document.querySelectorAll('.delete-file').forEach(button => {
                button.addEventListener('click', function() {
                    const fileId = this.getAttribute('data-file-id');
                    deletedFileIds.push(fileId);
                    this.closest('.existing-file').remove();
                });
            });

            // 수정
            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                try {
                    const formData = new FormData(this);

                    // 삭제된 파일 ID들 추가
                    deletedFileIds.forEach(fileId => {
                        formData.append('attachmentIds', fileId);
                    });

                    const response = await fetch(`/board/${boardId}`, {
                        method: 'POST',
                        // FormData에 이미 CSRF 토큰이 포함되어 있으므로 별도의 헤더 설정이 필요 없습니다
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || '서버 응답 에러');
                    }

                    const result = await response.json();
                    alert('게시글이 수정되었습니다.');
                    window.location.href = `/board/${result.id}`; // 상세 페이지로 이동

                } catch (error) {
                    console.error('Error:', error);
                    alert(error.message || '게시글 수정 중 오류가 발생했습니다.');
                }
            });
        });

        // 파일 크기 포맷팅
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</th:block>


<style>
    form {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    div {
        margin-bottom: 15px;
    }

    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    input[type="text"], textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    textarea {
        height: 200px;
        resize: vertical;
    }

    button {
        padding: 8px 15px;
        margin-right: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    button[type="submit"] {
        background-color: #007bff;
        color: white;
    }

    button[type="button"] {
        background-color: #6c757d;
        color: white;
    }

    .delete-file {
        background-color: #dc3545;
        color: white;
        padding: 2px 8px;
        font-size: 0.8em;
    }

    .existing-file {
        background-color: #f8f9fa;
        padding: 8px;
        margin-bottom: 5px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #newFileList div {
        padding: 5px;
        background-color: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 5px;
    }
</style>

</html>