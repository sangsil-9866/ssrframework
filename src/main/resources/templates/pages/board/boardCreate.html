<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">

<body>
<div layout:fragment="content">
    <h2>게시글 등록</h2>

    <form name="frm" action="/board" method="post" enctype="multipart/form-data">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <!-- 제목 -->
        <div>
            제목:
            <input type="text" name="title" required />
        </div>

        <!-- 내용 -->
        <div>
            내용:
            <textarea name="content" rows="10" cols="50" required></textarea>
        </div>

        <!-- 파일 첨부 -->
        <div>
            <label for="fileUpload">첨부파일</label>
            <input type="file" id="fileUpload" name="mFiles" multiple>
            <div id="fileList"></div>
        </div>

        <!-- 버튼 -->
        <div>
            <button type="submit">등록</button>
            <button type="button" onclick="location.href='/board'">목록</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form[name="frm"]');
        const fileUpload = document.getElementById('fileUpload');
        const fileList = document.getElementById('fileList');

        // 파일 선택 시 선택된 파일 목록 표시
        fileUpload.addEventListener('change', function() {
            fileList.innerHTML = '';
            Array.from(this.files).forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.textContent = `${file.name} (${formatFileSize(file.size)})`;
                fileList.appendChild(fileItem);
            });
        });

        // 등록
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const formData = new FormData(this);

                const response = await fetch('/board', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('서버 응답 에러');
                }

                const result = await response.json();
                alert('게시글이 등록되었습니다.');
                window.location.href = `/board/${result.id}`; // 상세 페이지로 이동

            } catch (error) {
                console.error('Error:', error);
                alert('게시글 등록 중 오류가 발생했습니다.');
            }
        });
    });

    // 파일 크기 포맷팅
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
</script>

<style>
    form {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    div {
        margin-bottom: 15px;
    }

    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    input[type="text"], textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    textarea {
        height: 200px;
        resize: vertical;
    }

    button {
        padding: 8px 15px;
        margin-right: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    button[type="submit"] {
        background-color: #007bff;
        color: white;
    }

    button[type="button"] {
        background-color: #6c757d;
        color: white;
    }

    #fileList {
        margin-top: 10px;
    }

    #fileList div {
        padding: 5px;
        background-color: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 5px;
    }
</style>

</body>
</html>
